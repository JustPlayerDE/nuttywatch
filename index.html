<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Twitch chat for Smartwatch</title>
    <link rel="stylesheet" href="./chat.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Ropa+Sans&display=swap"
      rel="stylesheet"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <div id="chat"></div>

    <script>
      const chatContainer = document.getElementById("chat");

      // https://stackoverflow.com/a/44169739
      const hash = window.location.hash.substr(1);
      const params = hash.split('&').reduce(function (res, item) {
          var parts = item.split('=');
          res[parts[0]] = parts[1];
          return res;
      }, {});

      const streamerbot = {
        isConnected: false,
        remoteAddress: params.socket
          ? "ws://" + params.socket
          : "ws://localhost:8080/",
        events: {
          Twitch: [
            "ChatMessage",
            "FirstWord",
            "Announcement",
            "UserTimedOut",
            "UserBanned",
            "ChatMessageDeleted",
          ],
          YouTube: ["Message", "MessageDeleted", "UserBanned", "SuperChat"],
        },
      };

      function removeChatLineById(messageId) {
        chatContainer
          .querySelectorAll("#" + messageId)
          .forEach((n) => chatContainer.removeChild(n));
      }

      function addMessage(
        id,
        message,
        author,
        color = "#ffffff", // TODO
        badges = [],
        messageType = "chat",
        timeout = 5000
      ) {
        const messageContainer = document.createElement("div");
        messageContainer.classList.add("chat-line");
        messageContainer.setAttribute("id", id);

        const messageLine = document.createElement("div");
        messageLine.classList.add("chat-line-inner");
        messageContainer.appendChild(messageLine);

        const badgeElement = document.createElement("span");
        const spacerElement = document.createElement("span");
        badgeElement.classList.add("badges");

        badges.forEach((badge) => {
          console.debug(["Badge", badge]);
          let badgeImgElement = document.createElement("img");
          badgeImgElement.setAttribute("src", badge.imageUrl);
          badgeImgElement.setAttribute("data-badge-name", badge.name);
          badgeImgElement.classList.add("badge");
          badgeElement.appendChild(badgeImgElement);
        });

        // Normal chat message
        if (messageType === "chat") {
          const authorNameElement = document.createElement("span");
          authorNameElement.classList.add("user-name");
          authorNameElement.innerText = author.name;
          authorNameElement.style.color = color;

          const seperatorElement = document.createElement("span");
          seperatorElement.classList.add("message-colon");
          seperatorElement.innerText = ": ";

          const messageElement = document.createElement("span");
          messageElement.classList.add("message");
          messageElement.innerText = message;

          messageContainer.setAttribute("data-user-id", author.id);

          messageLine.appendChild(badgeElement);
          messageLine.appendChild(spacerElement);
          messageLine.appendChild(authorNameElement);
          messageLine.appendChild(seperatorElement);
          messageLine.appendChild(messageElement);
        } else {
          // System Message
          const messageElement = document.createElement("span");
          messageElement.classList.add("message", "system");
          messageElement.innerText = message;

          messageLine.appendChild(badgeElement);
          messageLine.appendChild(messageElement);
        }

        // Append to chat
        chatContainer.appendChild(messageContainer);
        setTimeout(() => {
          messageContainer.classList.add("visible");
        }, 100);

        if (timeout && messageType === "system") {
          setTimeout(() => {
            if (!messageContainer) {
              return;
            }
            messageContainer.classList.remove("visible");
            setTimeout(() => chatContainer.removeChild(messageContainer), 1000);
          }, timeout);
        }
      }

      function addSystemMessage(id, message, timeout = 5000) {
        removeChatLineById(id);
        return addMessage(
          id,
          message,
          false,
          false,
          [
            {
              name: "System Icon",
              imageUrl:
                "https://justplayerde.github.io/nuttywatch/assets/warning-svgrepo-com.svg",
            },
          ],
          "system",
          timeout
        );
      }

      let socket;
      const eventHandler = {
        "obs-chat": function (event) {
          console.debug(["Successfully Subscribed to Streamerbot", event]);
        },
        Twitch: function (event) {
          console.debug(event);
          console.group("Twitch Event: " + event.event.type);

          if (event.event.type === "ChatMessage") {
            console.groupCollapsed("Chat Message");
            const chatMessage = event.data.message;
            console.debug(chatMessage);

            addMessage(
              chatMessage.msgId,
              chatMessage.message,
              {
                name: chatMessage.username,
                id: chatMessage.userId,
              },
              null,
              chatMessage.badges
            );

            console.groupEnd();
          } else {
            console.warn(["Unknown Twitch Event", event]);
          }

          console.groupEnd();
        },
        YouTube: function (event) {
          console.debug(event);
          console.group("YouTube Event: " + event.event.type);

          if (event.event.type === "Message") {
            console.groupCollapsed("Chat Message");
            const chatMessage = event.data.message;
            console.debug(chatMessage);

            addMessage(
              chatMessage.eventId,
              chatMessage.message,
              {
                name: chatMessage.user.name,
                id: chatMessage.user.id,
              },
              null,
              [
                {
                  name: "yt",
                  imageUrl:
                    "https://yt3.ggpht.com/m6yqTzfmHlsoKKEZRSZCkqf6cGSeHtStY4rIeeXLAk4N9GY_yw3dizdZoxTrjLhlY4r_rkz3GA=w28-h28-c-k-nd",
                },
              ]
            );

            console.groupEnd();
          } else {
            console.warn(["Unknown Youtube Event", event]);
          }

          console.groupEnd();
        },
      };

      function connect() {
        socket = new WebSocket(streamerbot.remoteAddress);

        socket.onopen = () => {
          let s = {
            request: "Subscribe",
            id: "obs-chat",
            events: streamerbot.events,
          };

          socket.send(JSON.stringify(s));

          console.debug(["Connected to Streamer.Bot:", socket]);
          addSystemMessage("status", "Connected to Streamerbot!");
          streamerbot.isConnected = true;
        };

        socket.onclose = function () {
          console.warn(
            "Disconnected from Streamer.Bot, reconnecting in 10 seconds..."
          );
          streamerbot.isConnected = false;
          setTimeout(connect, 10000);
        };

        socket.onmessage = async (streamerbotMessage) => {
          const data = JSON.parse(streamerbotMessage.data);
          console.debug(["Streamerbot Event", data]);

          if (eventHandler[data.id]) {
            eventHandler[data.id](data.events, data.status);
          } else if (data.event && eventHandler[data.event.source]) {
            eventHandler[data.event.source](data, data.type);
          }
        };
      }

      document.addEventListener(
        "DOMContentLoaded",
        function () {
          console.info("Document loaded, connecting to streamerbot...");
          addSystemMessage("status", "Connecting...", false);
          connect();
        },
        false
      );
    </script>
  </body>
</html>
